name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zipalign apksigner

        wget https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -O apktool.jar
        echo '#!/bin/bash' > apktool
        echo 'java -jar $(dirname $0)/apktool.jar "$@"' >> apktool
        chmod +x apktool
        sudo mv apktool apktool.jar /usr/local/bin/

    - name: Verify decompiled directory
      run: |
        if [ ! -d apktool_output ]; then
          echo "Error: apktool_output not found"
          exit 1
        fi

    - name: Rebuild APK
      run: |
        apktool b apktool_output -o xiaoya-unsigned.apk
        ls -lh xiaoya-unsigned.apk

    - name: Zipalign APK
      run: |
        zipalign -p -f -v 4 xiaoya-unsigned.apk xiaoya-aligned.apk

    - name: Decode signing key
      run: |
        echo "${{ secrets.XIAOYA_KEYSTORE_B64 }}" | base64 -d > xiaoya.keystore

    - name: Sign APK
      run: |
        apksigner sign \
          --ks xiaoya.keystore \
          --ks-pass pass:${{ secrets.XIAOYA_KEYSTORE_PASS }} \
          --key-pass pass:${{ secrets.XIAOYA_KEY_PASS }} \
          --ks-key-alias ${{ secrets.XIAOYA_KEY_ALIAS }} \
          --out bnu-xiaoya-revived.apk \
          xiaoya-aligned.apk

    - name: Verify APK signature
      run: |
        apksigner verify -v bnu-xiaoya-revived.apk

    - name: Generate checksums
      run: |
        sha256sum bnu-xiaoya-revived.apk > bnu-xiaoya-revived.apk.sha256
        md5sum bnu-xiaoya-revived.apk > bnu-xiaoya-revived.apk.md5

    - name: Generate timestamp tag
      id: timestamp
      run: |
        TAG=v$(date +"%Y.%-m.%-d")
        BUILD_TIME=$(TZ=Asia/Shanghai date +"%Y.%-m.%-d %H:%M")
        SHORT_SHA=${GITHUB_SHA::7}
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

    - name: Create and push tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.timestamp.outputs.tag }}
        git push origin ${{ steps.timestamp.outputs.tag }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.timestamp.outputs.tag }}
        name: ${{ steps.timestamp.outputs.tag }}
        files: |
          bnu-xiaoya-revived.apk
          bnu-xiaoya-revived.apk.sha256
          bnu-xiaoya-revived.apk.md5
        body: |
          构建时间: ${{ steps.timestamp.outputs.build_time }}
          提交: [${{ steps.timestamp.outputs.short_sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          ### 快速使用
          1. 下载最新的 `bnu-xiaoya-revived.apk`
          2. 确保旧版本的 `北师小鸦 2` 已被卸载
          3. 连接校园网
          4. 安装新 APK

          查看 [构建日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up keystore
      if: always()
      run: |
        rm -f xiaoya.keystore
